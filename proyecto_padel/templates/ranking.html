<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="{{ url_for('static', filename='img/isologo.png') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <title>RPM | Ranking</title>

    <!-- OVERRIDES CRÍTICOS (no tocan tu diseño, solo corrigen layout) -->
    <style>
        /* 1) Si borras el botón de WhatsApp, que no afecte nada */
        .wa-help,
        .wa-help-btn {
            display: none !important;
        }

        /* 2) ESTE ERA EL QUE ROMPÍA: tu CSS tenía .table-wrap #dos { position:absolute; top:450px; left:15px } */
        .table-wrap #dos {
            position: static !important;
            left: auto !important;
            top: auto !important;
        }

        /* 3) La tabla debe quedar en flujo normal */
        .table-wrap {
            overflow: visible !important;
            position: relative !important;
        }

        .table-viewport {
            height: auto !important;
            max-height: none !important;
            overflow-y: visible !important;
        }

        /* 4) Desktop: usa el THEAD real y apaga el overlay .rank-head */
        @media (min-width:641px) {

            html,
            body {
                overflow: auto !important;
                height: auto !important;
            }


            table[aria-labelledby="rank-head"] thead th {
                visibility: visible !important;
                color: #fff !important;
                background: rgba(1, 4, 7, 0) !important;
                border-color: rgba(255, 255, 255, .25) !important;
            }

            /* Anula márgenes “hack” que empujaban filas en móvil */
            .table-viewport {
                margin-top: 0 !important;
                padding-top: 0 !important;
            }
        }
    </style>
</head>

<body class="ranking-page">
    <div class="border-lines"></div>

    <!-- Background videos -->
    <video id="bg-video-desktop" class="bg-video" autoplay muted loop playsinline>
        <source src="{{ url_for('static', filename='video/background2.mp4') }}" type="video/mp4">
    </video>
    <video id="bg-video-mobile" class="bg-video" autoplay muted loop playsinline>
        <source src="{{ url_for('static', filename='video/background.mp4') }}" type="video/mp4">
    </video>

    <!-- Header -->
    <header class="app-header">
        <a href="{{ url_for('home') }}" class="logo1">
            <img src="{{ url_for('static', filename='img/logo.png') }}" alt="logo1" />
        </a>

        <nav class="main-nav" aria-label="Navegación">
            <button class="menu-btn" id="menu-toggle" type="button" aria-label="Abrir menú" aria-expanded="false">
                <span class="sr-only">Abrir menú</span>

                <!-- Icono hamburguesa -->
                <svg class="icon icon-burger" viewBox="0 0 24 24" width="28" height="28" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round">
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>

                <!-- Icono X -->
                <svg class="icon icon-close" viewBox="0 0 24 24" width="28" height="28" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round">
                    <line x1="5" y1="5" x2="19" y2="19"></line>
                    <line x1="19" y1="5" x2="5" y2="19"></line>
                </svg>
            </button>
        </nav>
    </header>

    <div class="page-scroll">
        {% if is_masculino or is_femenino %}
        {% set current_label =
        (cats | selectattr('value','equalto', current_cat) | map(attribute='label') | list | first)
        or ('1ra' if is_masculino else 'Femenino 1ra')
        %}
        <!-- Dropdown de Categorías -->
        <div class="cats-dropdown-wrap" id="cats-dd-root">
            <button class="cats-trigger" id="cats-trigger" aria-expanded="false" aria-controls="cats-menu"
                type="button">
                <span class="cats-trigger-text">{{ current_label }}</span>
                <svg class="cats-chevron" viewBox="0 0 24 24" aria-hidden="true" width="20" height="20">
                    <path d="M7 10l5 5 5-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
            </button>

            <ul class="cats-menu" id="cats-menu" role="menu" aria-labelledby="cats-trigger">
                {% for c in cats %}
                <li role="none">
                    <a role="menuitem" class="cats-item {{ 'active' if current_cat == c.value else '' }}"
                        href="{% if is_masculino %}{{ url_for('ranking_masculino', cat=c.value) }}{% else %}{{ url_for('ranking_femenino', cat=c.value) }}{% endif %}">
                        <span class="cats-item-label">{{ c.label }}</span>
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- SIDEBAR IZQUIERDO -->
        <div class="lbackdrop" id="lbackdrop"></div>
        <aside class="lside" id="lside" aria-hidden="true">
            <div class="lside-header">
                <h3 class="lside-title">Cambiar ranking</h3>
            </div>
            <div class="lside-body">
                <nav class="rank-list" aria-label="Cambiar de ranking">
                    <a class="rank-chip {{ 'active' if is_general else 'inactive' }}"
                        href="{{ url_for('ranking') }}">Ranking General</a>
                    <a class="rank-chip {{ 'active' if is_masculino else 'inactive' }}"
                        href="{{ url_for('ranking_masculino') }}">Ranking Masculino</a>
                    <a class="rank-chip {{ 'active' if is_femenino  else 'inactive' }}"
                        href="{{ url_for('ranking_femenino') }}">Ranking Femenino</a>
                </nav>
            </div>
            <div class="sidebar-footer">
                <p class="copyright">© 2025 RPM Ranking Pádel Montería.</p>
            </div>
        </aside>

        <!-- SIDEBAR DERECHO (categorías) -->
        {% if is_masculino or is_femenino %}
        <div class="rbackdrop" id="rbackdrop"></div>
        <aside class="rside" id="rside" aria-hidden="true">
            <div class="rside-header">
                <h3 class="rside-title">Categorías</h3>
                <button class="rside-close" id="rcat-close" aria-label="Cerrar">Cerrar</button>
            </div>
            <div class="rside-body">
                {% set current_cat = view.cat or '' %}
                <nav class="cat-list" aria-label="Elegir categoría">
                    {% for c in cats %}
                    {% set active = (current_cat == c.value) %}
                    <a class="cat-chip {{ 'active' if active else '' }}"
                        href="{% if is_masculino %}{{ url_for('ranking_masculino', cat=c.value) }}{% else %}{{ url_for('ranking_femenino', cat=c.value) }}{% endif %}">
                        <img src="{{ url_for('static', filename=c.img) }}" alt="{{ c.alt }}">
                        <span>{{ c.label }}</span>
                    </a>
                    {% endfor %}
                </nav>
            </div>
        </aside>
        {% endif %}

        <!-- Título -->
        <h2>
            {% if view.genero == 'M' and view.cat %} Masculino {{ view.cat }}
            {% elif view.genero == 'M' %} Ranking Masculino
            {% elif view.genero == 'F' and view.cat %} Femenino {{ view.cat }}
            {% elif view.genero == 'F' %} Ranking Femenino
            {% else %} Ranking General
            {% endif %}
        </h2>

        <!-- Buscador -->
        <div class="table-search">
            <div class="table-search-box">
                <input type="text" id="player-search" placeholder="Buscar jugador...">
            </div>
        </div>

        <!-- TABLA -->
        <div class="table-wrap">
            <!-- Encabezado overlay (solo móvil; en desktop lo apagamos con el override) -->
            <div class="rank-head" id="rank-head">
                <div class="rh-row">
                    <span class="rh-col rh-pos">POS</span>
                    <span class="rh-col rh-name">NOMBRE</span>
                    <span class="rh-col rh-rpm">ACT</span>
                    <span class="rh-col rh-cat">RPM</span>
                    <span class="rh-col rh-act">CAT</span>
                </div>
            </div>

            <!-- Contenedor que algunos estilos esperan como #dos -->
            <div id="dos">
                <div class="table-viewport">
                    <table id="ranking" aria-labelledby="rank-head">
                        <thead>
                            <tr>
                                <th>POS</th>
                                <th>NOMBRE</th>
                                <th>GEN</th>
                                <th>ACT</th>
                                <th>RPM</th>
                                <th class="cat">CAT</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in rows %}
                            <tr>
                                {% set is_gen = (request.path == url_for('ranking')) or (view.genero not in ['M','F'])
                                %}
                                {% set pos = (r.get('_pos', loop.index) | int) %}
                                {% set top_limit = 10 if is_gen else 3 %}

                                <td class="pos-cell {{ 'pos-grad' if is_gen else '' }} {% if pos <= top_limit %}pos-{{ pos }}{% endif %}"
                                    data-rank="{{ pos }}">{{ pos }}</td>
                                <td><span class="name">{{ r.get('Nombre del jugador', '') }}</span></td>
                                <td>{{ r.get('Género', '') }}</td>
                                <td class="act">
                                    {% if r.get('_movement') == 'up' %}
                                    <span class="arrow-up">▲</span>
                                    {% elif r.get('_movement') == 'down' %}
                                    <span class="arrow-down">▼</span>
                                    {% else %}
                                    <span class="arrow-right">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ r.get('Nivel de la sesión', '') }}</td>
                                <td><span class="categoria">{{ r.get('CAT. RPM OFICIAL', '') if is_gen else r.get('cat',
                                        '') }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div> <!-- /.table-wrap -->
    </div> <!-- /.page-scroll -->

    <!-- JS: sidebar izquierdo -->
    <script>
        (function () {
            const side = document.getElementById('lside');
            const back = document.getElementById('lbackdrop');
            const btnNew = document.getElementById('menu-toggle');
            if (!side || !back) return;

            function setState(isOpen) {
                side.classList.toggle('open', isOpen);
                back.classList.toggle('open', isOpen);
                side.setAttribute('aria-hidden', String(!isOpen));
                if (btnNew) {
                    btnNew.classList.toggle('is-open', isOpen);
                    btnNew.setAttribute('aria-expanded', String(isOpen));
                    const sr = btnNew.querySelector('.sr-only');
                    if (sr) sr.textContent = isOpen ? 'Cerrar menú' : 'Abrir menú';
                }
            }
            const toggleSide = () => setState(!side.classList.contains('open'));
            btnNew && btnNew.addEventListener('click', toggleSide);
            back.addEventListener('click', () => setState(false));
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') setState(false); });
            setState(false);
        })();
    </script>

    <!-- JS: sidebar derecho -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const rSide = document.getElementById('rside');
            const rBackdrop = document.getElementById('rbackdrop');
            const rOpenBtn = document.getElementById('rcat-open');
            const rCloseBtn = document.getElementById('rcat-close');
            function openR() { if (!rSide) return; rSide.classList.add('open'); rBackdrop && rBackdrop.classList.add('open'); rSide.setAttribute('aria-hidden', 'false'); rOpenBtn && rOpenBtn.setAttribute('aria-expanded', 'true'); }
            function closeR() { if (!rSide) return; rSide.classList.remove('open'); rBackdrop && rBackdrop.classList.remove('open'); rSide.setAttribute('aria-hidden', 'true'); rOpenBtn && rOpenBtn.setAttribute('aria-expanded', 'false'); }
            rOpenBtn && rOpenBtn.addEventListener('click', openR);
            rCloseBtn && rCloseBtn.addEventListener('click', closeR);
            rBackdrop && rBackdrop.addEventListener('click', closeR);
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeR(); });
        });
    </script>

    <!-- JS: búsqueda por nombre -->
    <script>
        (function () {
            const input = document.getElementById('player-search');
            if (!input) return;
            const TABLE_SELECTORS = ['#ranking'];
            const norm = (s) => (s || '').toString().normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().trim();
            function getNameText(tr) { const el = tr.querySelector('.name'); if (el) return el.textContent; const td = tr.cells && tr.cells[1]; return td ? td.textContent : ''; }
            function filterTable(table, q) {
                const query = norm(q);
                Array.from(table.tBodies[0].rows).forEach(tr => {
                    if (!tr.cells || tr.querySelector('th')) return;
                    tr.style.display = (!query || norm(getNameText(tr)).includes(query)) ? '' : 'none';
                });
            }
            function filterAll(q) { TABLE_SELECTORS.forEach(sel => { const tbl = document.querySelector(sel); tbl && filterTable(tbl, q); }); }
            let rafId = null;
            input.addEventListener('input', () => { if (rafId) cancelAnimationFrame(rafId); const q = input.value; rafId = requestAnimationFrame(() => filterAll(q)); });
            input.addEventListener('keydown', (e) => { if (e.key === 'Escape') { input.value = ''; filterAll(''); input.blur(); } });
            filterAll('');
        })();
    </script>

    <!-- JS: dropdown categorías -->
    <script>
        (function () {
            const trigger = document.getElementById('cats-trigger');
            const menu = document.getElementById('cats-menu');
            if (!trigger || !menu) return;
            trigger.addEventListener('click', () => {
                const expanded = trigger.getAttribute('aria-expanded') === 'true';
                trigger.setAttribute('aria-expanded', String(!expanded));
                menu.classList.toggle('open', !expanded);
            });
            document.addEventListener('click', (e) => {
                if (!menu.contains(e.target) && !trigger.contains(e.target)) {
                    trigger.setAttribute('aria-expanded', 'false');
                    menu.classList.remove('open');
                }
            });
        })();
    </script>

</body>

</html>